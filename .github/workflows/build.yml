name: build

on: push

jobs:
  build-linux:
    name: Linux
    runs-on: ubuntu-latest
    steps:
      - name: Cache Qt
        id: cache-qt
        uses: actions/cache@v1
        with:
          path: ../Qt
          key: ${{ runner.os }}-QtCache-5.15.2
      - uses: jurplel/install-qt-action@v2
        with:
          version: 5.15.2
          cached: ${{ steps.cache-qt.outputs.cache-hit }}
      - uses: actions/checkout@v2
      - name: Build
        run: |
          qmake "CONFIG+=release"
          make
          make clean
      - name: Build encrypted
        run: |
          qmake "CONFIG+=release" "CONFIG+=crypt"
          make
          make clean

  build-macos:
    name: macOS
    runs-on: macos-latest
    steps:
      - name: Cache Qt
        id: cache-qt
        uses: actions/cache@v1
        with:
          path: ../Qt
          key: ${{ runner.os }}-QtCache-5.15.2
      - uses: jurplel/install-qt-action@v2
        with:
          version: 5.15.2
          cached: ${{ steps.cache-qt.outputs.cache-hit }}
      - uses: actions/checkout@v2
      - name: Build
        run: |
          qmake "CONFIG+=release"
          make
          macdeployqt EffortLog.app -always-overwrite -verbose=3 -appstore-compliant -dmg
          mv EffortLog.dmg EffortLog_"${GITHUB_REF}"_osx.dmg
          otool -L EffortLog.app/Contents/MacOS/EffortLog
          make clean
      - name: Build encrypted
        run: |
          ls -al
          qmake "CONFIG+=release" "CONFIG+=crypt"
          make
          macdeployqt EffortLog.app -always-overwrite -verbose=3 -appstore-compliant -dmg
          mv EffortLog.dmg EffortLog_"${GITHUB_REF}"_osx_encrypted.dmg
          otool -L EffortLog.app/Contents/MacOS/EffortLog
          make clean
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: EffortLog_*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Windows
    runs-on: windows-latest
    steps:
      - name: Cache Qt
        id: cache-qt
        uses: actions/cache@v1
        with:
          path: ../Qt
          key: ${{ runner.os }}-QtCache-5.15.2
      - uses: jurplel/install-qt-action@v2
        with:
          version: 5.15.2
          arch: win64_mingw81
          cached: ${{ steps.cache-qt.outputs.cache-hit }}
      - name: Install Openssl
        run: choco install openssl -y
      - uses: actions/checkout@v2
      - name: Build
        shell: cmd
        run: |
          dir "C:\"
          dir "C:\Program Files\"
          dir "C:\Program Files\OpenSSL\"
          dir "C:\Program Files\OpenSSL\bin\"
          call "%programfiles(x86)%\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          qmake "CONFIG+=release"
          make
          mkdir bin
          move build\release\effort-log.exe bin
          7z a effort-log_"${GITHUB_REF}"_win64.zip bin\*
          make clean
      - name: Build encrypted
        shell: cmd
        run: |
          call "%programfiles(x86)%\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          qmake "CONFIG+=release" "CONFIG+=crypt"
          make
          mkdir bin
          move build\release\effort-log.exe bin
          copy "C:\Program Files\OpenSSL\libeay64.dll" bin\libeay64.dll
          copy "C:\Program Files\OpenSSL\libssl64.dll" bin\libssl64.dll
          copy "C:\Program Files\OpenSSL\ssleay64.dll" bin\ssleay64.dll
          7z a effort-log_"${GITHUB_REF}"_win64.zip bin\*
          make clean
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: effort-log_*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
